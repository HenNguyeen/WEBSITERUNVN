@model IEnumerable<DBStoreSport.Models.Product>
@{
    ViewBag.Title = "Danh mục sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/admin-dashboard.css" rel="stylesheet" />

<div class="admin-container">
    <div class="admin-header">
        <h2>📦 Danh mục sản phẩm</h2>
        <a href="@Url.Action("Create")" class="admin-add-btn">
            <i class="fas fa-plus"></i>
            Thêm sản phẩm mới
        </a>
    </div>

    <!-- Thông báo thành công -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Thanh tìm kiếm và bộ lọc -->
    <div class="search-filter-container">
        @using (Html.BeginForm("Index", "Products", FormMethod.Get, new { @class = "search-form" }))
        {
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" name="searchString" class="form-control" 
                               placeholder="Tìm kiếm sản phẩm..." 
                               value="@ViewBag.SearchString" />
                    </div>
                </div>
                
                <div class="col-md-2">
                    <select name="categoryFilter" class="form-select">
                        <option value="all">Tất cả danh mục</option>
                        @if (ViewBag.Categories != null)
                        {
                            foreach (var category in ViewBag.Categories)
                            {
                                <option value="@category.NameCate" 
                                        @(ViewBag.CategoryFilter == category.NameCate ? "selected" : "")>
                                    @category.NameCate
                                </option>
                            }
                        }
                    </select>
                </div>
                
                <div class="col-md-2">
                    <select name="priceFilter" class="form-select">
                        <option value="">Tất cả giá</option>
                        <option value="under100k" @(ViewBag.PriceFilter == "under100k" ? "selected" : "")>Dưới 100k</option>
                        <option value="100k-500k" @(ViewBag.PriceFilter == "100k-500k" ? "selected" : "")>100k - 500k</option>
                        <option value="500k-1m" @(ViewBag.PriceFilter == "500k-1m" ? "selected" : "")>500k - 1M</option>
                        <option value="over1m" @(ViewBag.PriceFilter == "over1m" ? "selected" : "")>Trên 1M</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <select name="sortOrder" class="form-select">
                        <option value="">Sắp xếp</option>
                        <option value="name_asc" @(ViewBag.SortOrder == "name_asc" ? "selected" : "")>Tên A-Z</option>
                        <option value="name_desc" @(ViewBag.SortOrder == "name_desc" ? "selected" : "")>Tên Z-A</option>
                        <option value="price_asc" @(ViewBag.SortOrder == "price_asc" ? "selected" : "")>Giá tăng dần</option>
                        <option value="price_desc" @(ViewBag.SortOrder == "price_desc" ? "selected" : "")>Giá giảm dần</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Tìm kiếm
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Xóa
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Thống kê kết quả -->
    @if (!string.IsNullOrEmpty(ViewBag.SearchString) || !string.IsNullOrEmpty(ViewBag.CategoryFilter) || !string.IsNullOrEmpty(ViewBag.PriceFilter))
    {
        <div class="search-results-info">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Kết quả tìm kiếm:</strong> 
                Tìm thấy @Model.Count() sản phẩm
                @if (!string.IsNullOrEmpty(ViewBag.SearchString))
                {
                    <span class="badge bg-primary ms-2">Từ khóa: "@ViewBag.SearchString"</span>
                }
                @if (!string.IsNullOrEmpty(ViewBag.CategoryFilter) && ViewBag.CategoryFilter != "all")
                {
                    <span class="badge bg-success ms-2">Danh mục: @ViewBag.CategoryFilter</span>
                }
                @if (!string.IsNullOrEmpty(ViewBag.PriceFilter))
                {
                    <span class="badge bg-warning ms-2">Giá: @ViewBag.PriceFilter</span>
                }
            </div>
        </div>
    }

    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên sản phẩm</th>
                    <th>Mô tả</th>
                    <th>Đơn giá</th>
                    <th>Tồn kho</th>
                    <th>Hình</th>
                    <th>Loại sản phẩm</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Any())
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.ProductID</td>
                            <td>
                                <strong>@Html.DisplayFor(modelItem => item.NamePro)</strong>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.DecriptionPro))
                                {
                                    <span title="@item.DecriptionPro">
                                        @(item.DecriptionPro.Length > 50 ? item.DecriptionPro.Substring(0, 50) + "..." : item.DecriptionPro)
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted">Không có mô tả</span>
                                }
                            </td>
                            <td class="text-danger fw-bold">@String.Format("{0:N0} đ", item.Price)</td>
                            <!-- 🧩 Cột tồn kho -->
                            <td>
                                @if (item.Quantity == 0)
                                {
                                    <span class="badge bg-danger">Hết hàng</span>
                                }
                                else if (item.Quantity < 5)
                                {
                                    <span class="badge bg-warning text-dark">Sắp hết (@item.Quantity)</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">@item.Quantity</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.ImagePro))
                                {
                                    <img src="~/Content/images/@item.ImagePro" alt="Hình ảnh" width="70" class="rounded shadow-sm" />
                                    <div class="text-muted small mt-1">@item.ImagePro</div>
                                }
                                else
                                {
                                    <span class="text-muted">Không có hình</span>
                                }
                            </td>
                            <td>
                                @if (item.Category != null)
                                {
                                    <span class="badge bg-info">@item.Category.NameCate</span>
                                }
                                else
                                {
                                    <span class="text-muted">Chưa phân loại</span>
                                }
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="@Url.Action("Edit", new { id = item.ProductID })" class="btn btn-sm btn-warning" title="Sửa">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="@Url.Action("Details", new { id = item.ProductID })" class="btn btn-sm btn-info" title="Chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="@Url.Action("Delete", new { id = item.ProductID })" class="btn btn-sm btn-danger" title="Xóa"
                                       onclick="return confirm('Bạn có chắc muốn xóa sản phẩm này?');">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">Không tìm thấy sản phẩm nào</h4>
                            <p class="text-muted">Hãy thử thay đổi từ khóa tìm kiếm hoặc bộ lọc</p>
                            <a href="@Url.Action("Index")" class="btn btn-primary">
                                <i class="fas fa-undo me-2"></i>Xem tất cả sản phẩm
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    
    <script>
        $(document).ready(function () {
            // Auto-submit form khi thay đổi dropdown
            $('select[name="categoryFilter"], select[name="priceFilter"], select[name="sortOrder"]').change(function () {
                $(this).closest('form').submit();
            });

            // Clear search khi click nút Xóa
            $('a[href="@Url.Action("Index")"]').click(function (e) {
                e.preventDefault();
                window.location.href = '@Url.Action("Index")';
            });
        });
    </script>
}

<style>
    .search-filter-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
    }

    .search-form {
        margin-bottom: 0;
    }

    .search-results-info {
        margin-bottom: 1rem;
    }

    .input-group-text {
        background-color: #fff;
        border-right: none;
    }

    .form-control {
        border-left: none;
    }

    .form-control:focus {
        border-color: #22c55e;
        box-shadow: 0 0 0 0.2rem rgba(34,197,94,0.25);
    }

    .form-select:focus {
        border-color: #22c55e;
        box-shadow: 0 0 0 0.2rem rgba(34,197,94,0.25);
    }

    .btn-group .btn {
        margin-right: 2px;
    }

    .btn-group .btn:last-child {
        margin-right: 0;
    }

    .badge {
        font-size: 0.85rem;
        padding: 6px 10px;
    }

    .table-responsive {
        border-radius: 16px;
        overflow: hidden;
    }

    .admin-table td {
        vertical-align: middle;
    }

    .admin-table img {
        max-width: 70px;
        height: auto;
    }
</style>
