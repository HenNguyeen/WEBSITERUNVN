@model DBStoreSport.Models.Product

@{
    ViewBag.Title = "Chi tiết sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    .product-card {
        border-radius: 18px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        background: #fff;
        padding: 2rem 2rem 1.5rem 2rem;
        max-width: 900px;
        margin: 40px auto 24px auto;
    }

    .product-img {
        border-radius: 12px;
        object-fit: cover;
        width: 100%;
        max-height: 320px;
        background: #f8f9fa;
    }

    .product-title {
        font-size: 2rem;
        font-weight: 700;
        color: #0d6efd;
    }

    .product-price {
        font-size: 1.4rem;
        color: #dc3545;
        font-weight: 600;
    }

    .product-badge {
        font-size: 1rem;
        border-radius: 12px;
        padding: 0.3em 1em;
    }

    .review-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
    }

    .review-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: #e9ecef;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #6c757d;
        margin-right: 10px;
    }

    .admin-reply {
        margin-left: 48px;
        color: #0d6efd;
        font-size: 0.98rem;
        margin-top: 2px;
    }
</style>

<div class="product-card">
    <div class="row g-4">
        <!-- Hình ảnh -->
        <div class="col-md-5">
            <img src="~/Content/images/@Model.ImagePro" class="product-img" alt="@Model.NamePro">
        </div>
        <!-- Nội dung -->
        <div class="col-md-7">
            <div>
                <div class="product-title mb-2">@Model.NamePro</div>
                <div class="mb-2 text-muted">@Model.DecriptionPro</div>
                <div class="mb-2">
                    <i class="bi bi-tag"></i> <b>Loại:</b> @Model.Category.NameCate
                </div>
                <div class="mb-2">
                    <i class="bi bi-cash-coin"></i> <span class="product-price">@Model.Price VNĐ</span>
                </div>
                <div class="mb-2">
                    <i class="bi bi-star-fill text-warning"></i>
                    <span class="text-warning">★★★★☆</span>
                    <small class="text-muted ms-1">(120 đánh giá)</small>
                </div>

                <!-- ✅ Thêm phần hiển thị số lượng tồn kho -->
                <div class="mb-3">
                    <i class="bi bi-box-seam"></i>
                    @if (Model.Quantity > 0)
                    {
                        <span class="badge bg-success product-badge">
                            Còn lại: @Model.Quantity sản phẩm
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-danger product-badge">
                            Hết hàng
                        </span>
                    }
                </div>
                <!-- ✅ Kết thúc phần mới -->

                <div class="d-flex gap-2 mt-4">
                    @if (Model.Quantity > 0)
                    {
                        <a href="@Url.Action("AddToCart", "ShoppingCart", new { id = Model.ProductID })" class="btn btn-success rounded-pill px-4">
                            <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-secondary rounded-pill px-4" disabled>
                            <i class="bi bi-x-circle"></i> Hết hàng
                        </button>
                    }

                    @Html.ActionLink("← Trở lại", "ProductList", null, new { @class = "btn btn-outline-secondary rounded-pill px-4" })
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container" style="max-width:900px;">
    <hr />
    <h3 class="mb-3"><i class="bi bi-chat-dots"></i> Đánh giá sản phẩm</h3>
    @if (Model.ProductReviews != null && Model.ProductReviews.Any())
    {
        foreach (var review in Model.ProductReviews)
        {
            <div class="review-card">
                <div class="d-flex align-items-center mb-1">
                    <div class="review-avatar">
                        <i class="bi bi-person"></i>
                    </div>
                    <strong>@review.Customer.NameCus</strong>
                    <span class="ms-2 text-warning" style="font-size:1.1rem;">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= review.Rating)
                            {
                                @:★
                            }
                            else
                            {
                                @:☆
                            }
                        }
                    </span>
                </div>
                <div class="ms-5">
                    @review.Comment <br />
                    @if (!string.IsNullOrEmpty(review.AdminReply))
                    {
                        <div class="admin-reply">
                            <b>Phản hồi từ Admin:</b> @review.AdminReply
                        </div>
                    }
                    <small class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy")</small>
                </div>
            </div>
        }
    }
    else
    {
        <p>Chưa có đánh giá nào cho sản phẩm này.</p>
    }

    @* Phần gửi đánh giá *@
    @if (Session["UserID"] != null)
    {
        <div class="card p-3 mt-4" style="max-width:500px;">
            <h5 class="mb-3">Gửi đánh giá của bạn</h5>
            @using (Html.BeginForm("Create", "ProductReview", FormMethod.Post))
            {
                @Html.Hidden("productId", Model.ProductID)
                <label>Đánh giá (1-5):</label>
                <input type="number" name="rating" min="1" max="5" required class="form-control mb-2" style="width:100px;display:inline-block;" />
                <label>Bình luận:</label>
                <textarea name="comment" required class="form-control mb-2" rows="3"></textarea>
                <button type="submit" class="btn btn-primary rounded-pill px-4">Gửi</button>
            }
        </div>
    }
    else
    {
        <p class="mt-3">Bạn cần <a href="@Url.Action("Login", "Account")">đăng nhập</a> để đánh giá.</p>
    }
</div>

<!-- Nút scroll to top -->
<button class="btn btn-primary scroll-to-top" aria-label="Scroll to top" style="display:none;"><i class="bi bi-arrow-up"></i></button>

<style>
    .scroll-to-top {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 9999;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        background: #0d6efd;
        color: #fff;
        border: none;
        transition: opacity 0.2s;
    }
</style>

<script>
    // Ẩn/hiện nút khi cuộn
    window.addEventListener('scroll', function () {
        var btn = document.querySelector('.scroll-to-top');
        if (btn) btn.style.display = window.scrollY > 200 ? 'flex' : 'none';
    });
    // Cuộn lên đầu trang khi click
    document.addEventListener('DOMContentLoaded', function () {
        var btn = document.querySelector('.scroll-to-top');
        if (btn) btn.onclick = function () { window.scrollTo({ top: 0, behavior: 'smooth' }); };
    });
</script>
