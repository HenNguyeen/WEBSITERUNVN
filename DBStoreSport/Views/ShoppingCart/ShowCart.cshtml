@model DBSportStore.Models.Cart

@{
    ViewBag.Title = "Giỏ hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4 mb-5">
    <h2 class="text-primary">🛒 Giỏ Hàng</h2>
    <a class="btn btn-outline-secondary mb-3" href="@Url.Action("ProductList", "Products")">⬅️ Tiếp tục mua hàng</a>

    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>❌ Lỗi:</strong> @ViewBag.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>✅ Thành công:</strong> @ViewBag.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model != null && Model.Items.Any())
    {
        <table class="table table-bordered table-hover text-center align-middle shadow">
            <thead class="table-dark">
                <tr>
                    <th>Tên Sản phẩm</th>
                    <th>Hình</th>
                    <th>Giá</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                    <th>Xóa</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    decimal total = item._quantity * (decimal)item._product.Price.Value;
                    <tr>
                        <td>@item._product.NamePro</td>
                        <td>
                            <img src="@Url.Content("~/Content/images/" + item._product.ImagePro)"
                                 alt="@item._product.NamePro"
                                 width="80" height="80"
                                 style="object-fit:cover; border-radius:8px;" />
                        </td>
                        <td class="text-danger">@(item._product.Price.HasValue ? item._product.Price.Value.ToString("N0") : "") VNĐ</td>
                        <td>
                            @using (Html.BeginForm("Update_Cart_Quantity", "ShoppingCart"))
                            {
                                <input type="hidden" name="idPro" value="@item._product.ProductID" />
                                <input type="number" name="carQuantity" value="@item._quantity" class="form-control d-inline-block w-50" min="1" />
                                <button type="submit" class="btn btn-primary btn-sm mt-1">Cập nhật</button>
                            }
                        </td>

                        <td>
                            <a href="@Url.Action("RemoveCart", "ShoppingCart", new { id = item._product.ProductID })"
                               class="btn btn-outline-danger btn-sm">Xóa</a>
                        </td>
                        <td colspan="5" style="text-align:right;">
                            @using (Html.BeginForm("ApplyVoucher", "ShoppingCart", FormMethod.Post))
                            {
                                <input type="text" name="voucherCode" placeholder="Nhập mã giảm giá..." class="form-control" style="width:200px; display:inline-block;" required />
                                <input type="submit" value="Áp dụng" class="btn btn-info" />
                            }
                            <p style="color:green;">@ViewBag.VoucherMessage</p>
                        </td>
                    </tr>
                }
            </tbody>
            @{
                decimal discount = 0;
                if (Session["Voucher"] != null)
                {
                    var voucher = (DBStoreSport.Models.Voucher)Session["Voucher"];
                    if (voucher.Type == "Percent")
                    {
                        discount = Model.Total_money() * voucher.DiscountValue / 100;
                    }
                    else if (voucher.Type == "Fixed")
                    {
                        discount = voucher.DiscountValue;
                    }
                }
            }

            <tfoot>
                <tr>
                    <td colspan="6" class="text-end">
                        <strong>Tạm tính:</strong>
                        <span class="text-muted">@Model.Total_money().ToString("N0") VNĐ</span>
                    </td>
                </tr>
                @if (Session["Voucher"] != null)
                {
                    var voucher = (DBStoreSport.Models.Voucher)
                        Session["Voucher"];
                    string voucherText = voucher.Type == "Percent"
                        ? $"{voucher.DiscountValue}%"
                        : $"{voucher.DiscountValue:N0} VNĐ";

                    <tr>
                        <td colspan="6" class="text-end text-success">
                            <strong>Giảm giá:</strong>
                            <span class="text-success">-@discount.ToString("N0") VNĐ</span>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="6" class="text-end text-danger fs-5">
                            <strong>Tổng sau giảm: @( (Model.Total_money() - discount).ToString("N0") ) VNĐ</strong>
                        </td>
                    </tr>
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-end text-danger fs-5">
                            <strong>Tổng tiền: @Model.Total_money().ToString("N0") VNĐ</strong>
                        </td>
                    </tr>
                }
            </tfoot>


        </table>

        <!-- Cập nhật file: Views/ShoppingCart/ShowCart.cshtml -->
        <!-- Thay thế phần form đặt hàng (dòng 134-154) -->

        <!-- Form Đặt hàng -->
        <div class="mt-4 p-4 border rounded bg-light shadow-sm">
            <h5 class="mb-3 text-success">Thông tin giao hàng & Thanh toán</h5>
            @using (Html.BeginForm("ProcessPayment", "ShoppingCart"))
            {
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Địa chỉ giao hàng:</label>
                        <input type="text" name="AddressDeliverry" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Số điện thoại</label>
                        <input type="text" name="Number" class="form-control" required />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Khách hàng:</label>
                        @if (Session["UserID"] != null)
                        {
                            <div class="form-control-plaintext bg-light p-2 rounded">
                                <i class="fas fa-user text-primary"></i>
                                <strong>@Session["UserName"]</strong>
                                <small class="text-muted d-block">ID: @Session["UserID"]</small>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning p-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Vui lòng đăng nhập để đặt hàng!</strong>
                                <br>
                                <a href="@Url.Action("Login", "Account")" class="btn btn-sm btn-primary mt-1">
                                    <i class="fas fa-sign-in-alt"></i> Đăng nhập ngay
                                </a>
                            </div>
                        }
                    </div>

                    <!-- Phương thức thanh toán -->
                    <div class="col-12">
                        <label class="form-label fw-bold">Chọn phương thức thanh toán:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check payment-method-card">
                                    <input class="form-check-input" type="radio" name="paymentMethod" value="vnpay" id="vnpay" checked>
                                    <label class="form-check-label" for="vnpay">
                                        <div class="payment-option">
                                            <i class="fas fa-credit-card text-primary"></i>
                                            <div>
                                                <strong>VNPay</strong>
                                                <small class="d-block text-muted">Thẻ ATM/Internet Banking</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check payment-method-card">
                                    <input class="form-check-input" type="radio" name="paymentMethod" value="cod" id="cod">
                                    <label class="form-check-label" for="cod">
                                        <div class="payment-option">
                                            <i class="fas fa-money-bill-wave text-success"></i>
                                            <div>
                                                <strong>COD</strong>
                                                <small class="d-block text-muted">Thanh toán khi nhận hàng</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 text-end mt-3">
                        @if (Session["UserID"] != null)
                        {
                            <button type="submit" class="btn btn-success btn-lg me-2">
                                <i class="fas fa-shopping-cart"></i> Đặt hàng
                            </button>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>Vui lòng đăng nhập để đặt hàng!</strong>
                                <a href="@Url.Action("Login", "Account")" class="btn btn-primary ms-2">
                                    <i class="fas fa-sign-in-alt"></i> Đăng nhập
                                </a>
                                <a href="@Url.Action("Register", "Account")" class="btn btn-outline-primary ms-1">
                                    <i class="fas fa-user-plus"></i> Đăng ký
                                </a>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <style>
            .payment-method-card {
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                transition: all 0.3s ease;
            }

                .payment-method-card:hover {
                    border-color: #007bff;
                    background-color: #f8f9fa;
                }

                .payment-method-card input[type="radio"]:checked + label .payment-option {
                    color: #007bff;
                }

            .payment-option {
                display: flex;
                align-items: center;
                gap: 10px;
            }

                .payment-option i {
                    font-size: 1.5rem;
                }

        </style>
    }
    else
    {
        <div class="alert alert-info mt-4">
            <strong>Giỏ hàng của bạn đang trống!</strong> Vui lòng tiếp tục mua hàng.
        </div>
    }
</div>
